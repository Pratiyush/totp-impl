name: Maven Publish (Approach 3)

on:
  push:
    branches:
      - main
      - master

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      # --------------------------------------------------
      # Checkout
      # --------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # --------------------------------------------------
      # Java setup
      # --------------------------------------------------
      - name: Set up Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      # --------------------------------------------------
      # Cache Maven
      # --------------------------------------------------
      - name: Cache Maven repository
        uses: actions/cache@v3
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      # --------------------------------------------------
      # Import GPG key
      # --------------------------------------------------
      - name: Import GPG private key
        run: |
          mkdir -p ~/.gnupg
          chmod 700 ~/.gnupg
          echo "${{ secrets.GPG_PRIVATE_KEY }}" | gpg --batch --import
          echo "pinentry-mode loopback" >> ~/.gnupg/gpg.conf
          chmod 600 ~/.gnupg/gpg.conf

      # --------------------------------------------------
      # Verify GPG (optional but recommended)
      # --------------------------------------------------
      - name: Verify GPG keys
        run: |
          gpg --list-secret-keys --keyid-format LONG || true

      # --------------------------------------------------
      # Calculate next version
      # --------------------------------------------------
      - name: Calculate version
        id: version
        run: |
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          VERSION="${LATEST_TAG#v}"

          if [ "$VERSION" = "0.0.0" ]; then
            NEXT_VERSION="1.0.0-SNAPSHOT"
          else
            IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"
            PATCH=$((PATCH + 1))
            NEXT_VERSION="$MAJOR.$MINOR.$PATCH-SNAPSHOT"
          fi

          echo "version=$NEXT_VERSION" >> "$GITHUB_OUTPUT"
          echo "Next version: $NEXT_VERSION"

      # --------------------------------------------------
      # Configure Git user
      # --------------------------------------------------
      - name: Configure Git
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

      # --------------------------------------------------
      # Build & Deploy
      # --------------------------------------------------
      - name: Build, sign and deploy
        env:
          SONATYPE_USERNAME: ${{ secrets.SONATYPE_USERNAME }}
          SONATYPE_TOKEN: ${{ secrets.SONATYPE_TOKEN }}
          MAVEN_GPG_PASSPHRASE: ${{ secrets.MAVEN_GPG_PASSPHRASE }}
          GPG_KEY_ID: "CAADD90371C77C72"
        run: |
          mvn clean deploy \
            -s .github/maven/settings.xml \
            -P release \
            -Drevision=${{ steps.version.outputs.version }} \
            -Dgpg.useagent=false \
            -DskipTests \
            --batch-mode

      # --------------------------------------------------
      # Create Git tag (only non-SNAPSHOT)
      # --------------------------------------------------
      - name: Create Git tag
        if: "!contains(steps.version.outputs.version, 'SNAPSHOT')"
        run: |
          git tag "v${{ steps.version.outputs.version }}"
          git push origin "v${{ steps.version.outputs.version }}"

      # --------------------------------------------------
      # Create GitHub Release
      # --------------------------------------------------
      - name: Create GitHub Release
        if: "!contains(steps.version.outputs.version, 'SNAPSHOT')"
        uses: ncipollo/release-action@v1
        with:
          tag: "v${{ steps.version.outputs.version }}"
          name: "Release v${{ steps.version.outputs.version }}"
          body: "Automated release v${{ steps.version.outputs.version }}"
          draft: false
          prerelease: false
