name: Maven Publish (Approach 3 - fixed GPG)

on:
  push:
    branches: [ main, master ]

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Cache Maven repository
        uses: actions/cache@v3
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Install GPG + pinentry
        run: |
          sudo apt-get update -y
          # Install gpg and a pinentry implementation
          sudo apt-get install -y --no-install-recommends gnupg2 gnupg-agent pinentry-curses
          gpg --version

      - name: Configure GPG agent for loopback (non-interactive CI)
        run: |
          mkdir -p ~/.gnupg
          chmod 700 ~/.gnupg

          # Enable loopback pinentry to allow passphrase via --pinentry-mode loopback
          echo "allow-loopback-pinentry" >> ~/.gnupg/gpg-agent.conf

          # pinentry-program ensures pinentry binary path (adjust if different)
          if [ -x "/usr/bin/pinentry-curses" ]; then
            echo "pinentry-program /usr/bin/pinentry-curses" >> ~/.gnupg/gpg-agent.conf
          elif [ -x "/usr/bin/pinentry" ]; then
            echo "pinentry-program /usr/bin/pinentry" >> ~/.gnupg/gpg-agent.conf
          fi

          # Make sure gpg.conf also includes loopback mode setting for some gpg versions
          echo "pinentry-mode loopback" >> ~/.gnupg/gpg.conf
          chmod 600 ~/.gnupg/gpg-agent.conf ~/.gnupg/gpg.conf

          # Restart gpg-agent so changes take effect
          gpgconf --homedir "$HOME/.gnupg" --kill gpg-agent || true
          sleep 1
          gpgconf --homedir "$HOME/.gnupg" --launch gpg-agent || true

      - name: Import GPG private key
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        run: |
          set -euo pipefail
          # Import private key (expects ASCII-armored key in the secret)
          printf '%s\n' "$GPG_PRIVATE_KEY" | gpg --batch --import
          # Verify
          gpg --list-secret-keys --keyid-format LONG

      - name: Debug GPG (key ID shown)
        run: |
          echo "Secret keys (long ids):"
          gpg --list-secret-keys --keyid-format LONG || true
          echo "Detected key fingerprint (colon format):"
          gpg --list-secret-keys --with-colons | awk -F: '/^sec/ {print $5}' || true

      - name: Calculate version
        id: version
        run: |
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          VERSION="${LATEST_TAG#v}"
          if [ "$VERSION" = "0.0.0" ]; then
            NEXT_VERSION="1.0.0-SNAPSHOT"
          else
            IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"
            PATCH=$((PATCH + 1))
            NEXT_VERSION="$MAJOR.$MINOR.$PATCH-SNAPSHOT"
          fi
          echo "version=$NEXT_VERSION" >> "$GITHUB_OUTPUT"
          echo "Next version: $NEXT_VERSION"

      - name: Build, sign and deploy
        env:
          SONATYPE_USERNAME: ${{ secrets.SONATYPE_USERNAME }}
          SONATYPE_TOKEN: ${{ secrets.SONATYPE_TOKEN }}
          MAVEN_GPG_PASSPHRASE: ${{ secrets.MAVEN_GPG_PASSPHRASE }}
          GPG_KEY_ID: ${{ secrets.GPG_KEY_ID }}
        run: |
          # Use loopback pinentry via maven-gpg-plugin gpgArguments defined in pom.xml
          mvn -B -e -DskipTests clean deploy \
            -s .github/maven/settings.xml \
            -P release \
            -Drevision=${{ steps.version.outputs.version }}

      - name: Create Git tag (only non-SNAPSHOT)
        if: "!contains(steps.version.outputs.version, 'SNAPSHOT')"
        run: |
          git tag "v${{ steps.version.outputs.version }}"
          git push origin "v${{ steps.version.outputs.version }}"

      - name: Create GitHub Release (only non-SNAPSHOT)
        if: "!contains(steps.version.outputs.version, 'SNAPSHOT')"
        uses: ncipollo/release-action@v1
        with:
          tag: "v${{ steps.version.outputs.version }}"
          name: "Release v${{ steps.version.outputs.version }}"
          body: "Automated release v${{ steps.version.outputs.version }}"
          draft: false
          prerelease: false
